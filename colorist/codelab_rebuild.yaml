name: Colorist rebuild script
steps:
  - name: step_00
    steps:
      - name: Remove generated code
        rmdir: step_00
      - name: Create project
        flutter: create -e colorist --platforms=android,ios,macos,web,windows
      - name: Replace pubspec.yaml with a correctly ordered one
        path: colorist/pubspec.yaml
        replace-contents: |
          name: colorist
          description: "A new Flutter project."
          publish_to: "none"
          version: 0.1.0

          environment:
            sdk: ^3.7.2

          dependencies:
            flutter:
              sdk: flutter

          dev_dependencies:
            flutter_lints: ^5.0.0
            flutter_test:
              sdk: flutter

          flutter:
            uses-material-design: true
      - name: Upgrade deps
        path: colorist
        flutter: pub upgrade --major-versions
      - name: Copy step_00
        copydir:
          from: colorist
          to: step_00
  - name: step_01
    steps:
      - name: Remove generated code
        rmdir: step_01
      - name: Add dependencies
        path: colorist
        flutter: pub add colorist_ui flutter_riverpod logging riverpod_annotation dev:build_runner dev:custom_lint dev:riverpod_generator dev:riverpod_lint dev:json_serializable
      - name: Strip DEVELOPMENT_TEAM
        strip-lines-containing: DEVELOPMENT_TEAM =
        path: colorist/ios/Runner.xcodeproj/project.pbxproj
      - name: Configure analysis_options.yaml
        path: colorist/analysis_options.yaml
        replace-contents: |
          include: ../../analysis_options.yaml

          analyzer:
            plugins:
              - custom_lint

          linter:
            rules:
              sort_pub_dependencies: true
      - name: dart fix
        path: colorist
        dart: fix --apply
      - name: Remove README
        rm: colorist/README.md
      - name: Add .vscode directory
        mkdir: colorist/.vscode
      - name: Add .vscode/launch.json
        path: colorist/.vscode/launch.json
        replace-contents: |
          {
              // Use IntelliSense to learn about possible attributes.
              // Hover to view descriptions of existing attributes.
              // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
              "version": "0.2.0",
              "configurations": [
                  {
                      "name": "colorist",
                      "request": "launch",
                      "type": "dart"
                  }
              ]
          }
      - name: Replace lib/main.dart
        path: colorist/lib/main.dart
        replace-contents: |
          // Copyright 2025 The Flutter Authors. All rights reserved.
          // Use of this source code is governed by a BSD-style license that can be
          // found in the LICENSE file.

          import 'package:colorist_ui/models/message.dart';
          import 'package:colorist_ui/providers/chat_state_notifier.dart';
          import 'package:colorist_ui/providers/log_state_notifier.dart';
          import 'package:colorist_ui/ui/screens/main_screen.dart';
          import 'package:flutter/foundation.dart';
          import 'package:flutter/material.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:logging/logging.dart';

          void main() async {
            Logger.root.level = Level.ALL;
            Logger.root.onRecord.listen((record) {
              if (kDebugMode) {
                print(
                  '${record.loggerName}: ${record.level.name}: '
                  '${record.time}: ${record.message}',
                );
              }
            });

            runApp(ProviderScope(child: MainApp()));
          }

          class MainApp extends ConsumerWidget {
            const MainApp({super.key});

            @override
            Widget build(BuildContext context, WidgetRef ref) {
              return MaterialApp(
                theme: ThemeData(
                  colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
                ),
                home: MainScreen(
                  sendMessage: (message) {
                    sendMessage(message, ref);
                  },
                ),
              );
            }

            // A fake LLM that just echoes back what it receives.
            void sendMessage(String message, WidgetRef ref) {
              final chatStateNotifier = ref.read(chatStateNotifierProvider.notifier);
              final logStateNotifier = ref.read(logStateNotifierProvider.notifier);

              chatStateNotifier.addUserMessage(message);
              logStateNotifier.logUserText(message);
              chatStateNotifier.addLlmMessage(message, MessageState.complete);
              logStateNotifier.logLlmText(message);
            }
          }
      - name: Upgrade deps
        path: colorist
        flutter: pub upgrade --major-versions
      - name: Build iOS simulator bundle
        platforms: [macos]
        path: colorist
        flutter: build ios --simulator
      - name: Build Android app
        path: colorist
        flutter: build apk
      - name: Build macOS app
        platforms: [macos]
        path: colorist
        flutter: build macos
      - name: Build Linux app
        platforms: [linux]
        path: colorist
        flutter: build linux
      - name: Build Windows app
        platforms: [windows]
        path: colorist
        flutter: build windows
      - name: Copy step_01
        copydir:
          from: colorist
          to: step_01
      - name: Flutter clean
        path: step_01
        flutter: clean
  - name: step_02
    steps:
      - name: Remove generated code
        rmdir: step_02
      - name: Add Firebase Vertex AI dependencies
        path: colorist
        flutter: pub add firebase_core firebase_vertexai
      - name: Patch android/app/build.gradle.kts
        path: colorist/android/app/build.gradle.kts
        patch-u: |
          --- b/firebase-get-to-know-flutter/step_02/android/app/build.gradle
          +++ a/firebase-get-to-know-flutter/step_02/android/app/build.gradle
          @@ -24,7 +24,7 @@ android {
                   applicationId = "com.example.colorist"
                   // You can update the following values to match your application needs.
                   // For more information, see: https://flutter.dev/to/review-gradle-config.
          -        minSdk = flutter.minSdkVersion
          +        minSdk = 23
                   targetSdk = flutter.targetSdkVersion
                   versionCode = flutter.versionCode
                   versionName = flutter.versionName
      - name: Patch macos/Podfile
        path: colorist/macos/Podfile
        patch-u: |
          --- b/colorist/step_02/macos/Podfile
          +++ a/colorist/step_02/macos/Podfile
          @@ -1,4 +1,5 @@
          -platform :osx, '10.14'
          +# Firebase requires at least macOS 10.15
          +platform :osx, '10.15'

           # CocoaPods analytics sends network stats synchronously affecting flutter build latency.
           ENV['COCOAPODS_DISABLE_STATS'] = 'true'
      - name: Patch macos/Runner.xcodeproj/project.pbxproj
        xcode-project-path: colorist/macos/Runner.xcodeproj
        macosx-deployment-target: "10.15"
      - name: Patch ios/Podfile
        path: colorist/ios/Podfile
        patch-u: |
          --- a/firebase-get-to-know-flutter/step_02/ios/Podfile
          +++ b/firebase-get-to-know-flutter/step_02/ios/Podfile
          @@ -1,5 +1,5 @@
          -# Uncomment this line to define a global platform for your project
          -# platform :ios, '12.0'
          +# Firebase requires at least iOS 13.0
          +platform :ios, '13.0'

           # CocoaPods analytics sends network stats synchronously affecting flutter build latency.
           ENV['COCOAPODS_DISABLE_STATS'] = 'true'
      - name: Patch ios/Runner.xcodeproj/project.pbxproj
        xcode-project-path: colorist/ios/Runner.xcodeproj
        iphoneos-deployment-target: "13.0"
      - name: Upgrade deps
        path: colorist
        flutter: pub upgrade --major-versions
      - name: Build iOS simulator bundle
        platforms: [macos]
        path: colorist
        flutter: build ios --simulator
      - name: Build Android app
        path: colorist
        flutter: build apk
      - name: Build macOS app
        platforms: [macos]
        path: colorist
        flutter: build macos
      - name: Build Linux app
        platforms: [linux]
        path: colorist
        flutter: build linux
      - name: Build Windows app
        platforms: [windows]
        path: colorist
        flutter: build windows
      - name: Copy step_02
        copydir:
          from: colorist
          to: step_02
      - name: Flutter clean
        path: step_02
        flutter: clean
  - name: Cleanup
    rmdir: colorist
