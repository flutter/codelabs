name: Colorist rebuild script
steps:
  - name: step_01
    steps:
      - name: Remove generated code
        rmdir: step_01
      - name: Create project
        flutter: create -e colorist --platforms=android,ios,macos,web,windows
      - name: Add dependencies
        path: colorist
        flutter: pub add colorist_ui flutter_riverpod logging riverpod_annotation dev:build_runner dev:riverpod_generator dev:riverpod_lint dev:json_serializable
      - name: Strip DEVELOPMENT_TEAM
        strip-lines-containing: DEVELOPMENT_TEAM =
        path: colorist/ios/Runner.xcodeproj/project.pbxproj
      - name: Configure analysis_options.yaml
        path: colorist/analysis_options.yaml
        replace-contents: |
          include: ../../analysis_options.yaml
      - name: dart fix
        path: colorist
        dart: fix --apply
      - name: Remove README
        rm: colorist/README.md
      - name: Add .vscode directory
        mkdir: colorist/.vscode
      - name: Add .vscode/launch.json
        path: colorist/.vscode/launch.json
        replace-contents: |
          {
              // Use IntelliSense to learn about possible attributes.
              // Hover to view descriptions of existing attributes.
              // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
              "version": "0.2.0",
              "configurations": [
                  {
                      "name": "colorist",
                      "request": "launch",
                      "type": "dart"
                  }
              ]
          }
      - name: Replace lib/main.dart
        path: colorist/lib/main.dart
        replace-contents: |
          // Copyright 2025 The Flutter Authors. All rights reserved.
          // Use of this source code is governed by a BSD-style license that can be
          // found in the LICENSE file.

          import 'package:colorist_ui/models/message.dart';
          import 'package:colorist_ui/providers/chat_state_notifier.dart';
          import 'package:colorist_ui/providers/log_state_notifier.dart';
          import 'package:colorist_ui/ui/screens/main_screen.dart';
          import 'package:flutter/foundation.dart';
          import 'package:flutter/material.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:logging/logging.dart';

          void main() async {
            Logger.root.level = Level.ALL;
            Logger.root.onRecord.listen((record) {
              if (kDebugMode) {
                print(
                  '${record.loggerName}: ${record.level.name}: '
                  '${record.time}: ${record.message}',
                );
              }
            });

            runApp(ProviderScope(child: MainApp()));
          }

          class MainApp extends ConsumerWidget {
            const MainApp({super.key});

            @override
            Widget build(BuildContext context, WidgetRef ref) {
              return MaterialApp(
                theme: ThemeData(
                  colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
                ),
                home: MainScreen(
                  sendMessage: (message) {
                    sendMessage(message, ref);
                  },
                ),
              );
            }

            // A fake LLM that just echoes back what it receives.
            void sendMessage(String message, WidgetRef ref) {
              final chatStateNotifier = ref.read(chatStateNotifierProvider.notifier);
              final logStateNotifier = ref.read(logStateNotifierProvider.notifier);

              chatStateNotifier.addUserMessage(message);
              logStateNotifier.logUserText(message);
              chatStateNotifier.addLlmMessage(message, MessageState.complete);
              logStateNotifier.logLlmText(message);
            }
          }
      - name: Upgrade deps
        path: colorist
        flutter: pub upgrade --major-versions
      - name: Build iOS simulator bundle
        platforms: [macos]
        path: colorist
        flutter: build ios --simulator
      - name: Build Android app
        path: colorist
        flutter: build apk
      - name: Build macOS app
        platforms: [macos]
        path: colorist
        flutter: build macos
      - name: Build Windows app
        platforms: [windows]
        path: colorist
        flutter: build windows
      - name: Copy step_01
        copydir:
          from: colorist
          to: step_01
      - name: Flutter clean
        path: step_01
        flutter: clean
  - name: step_02
    steps:
      - name: Remove generated code
        rmdir: step_02
      - name: Add Firebase Vertex AI dependencies
        path: colorist
        flutter: pub add firebase_core firebase_vertexai
      - name: Add lib/firebase_options.dart
        path: colorist/lib/firebase_options.dart
        replace-contents: |
          // File normally generated by FlutterFire CLI. This is a stand-in.
          // Remove this file and run `flutterfire configure`
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;

          class DefaultFirebaseOptions {
            // TODO: Run `flutterfire configure` to re-generate this file
            static FirebaseOptions get currentPlatform {
              throw UnimplementedError(
                'Regenerate this file by running `flutterfire configure`. ',
              );
            }
          }
      - name: Mkdir lib/providers
        path: colorist
        mkdir: lib/providers
      - name: Add lib/providers/gemini.dart
        path: colorist/lib/providers/gemini.dart
        replace-contents: |
          // Copyright 2025 The Flutter Authors. All rights reserved.
          // Use of this source code is governed by a BSD-style license that can be
          // found in the LICENSE file.

          import 'dart:async';

          import 'package:firebase_core/firebase_core.dart';
          import 'package:firebase_vertexai/firebase_vertexai.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:riverpod_annotation/riverpod_annotation.dart';

          import '../firebase_options.dart';

          part 'gemini.g.dart';

          @riverpod
          Future<FirebaseApp> firebaseApp(Ref ref) =>
              Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

          @riverpod
          Future<GenerativeModel> geminiModel(Ref ref) async {
            await ref.watch(firebaseAppProvider.future);

            final model = FirebaseVertexAI.instance.generativeModel(
              model: 'gemini-2.0-flash',
            );
            return model;
          }

          @Riverpod(keepAlive: true)
          Future<ChatSession> chatSession(Ref ref) async {
            final model = await ref.watch(geminiModelProvider.future);
            return model.startChat();
          }
      - name: Mkdir lib/services
        path: colorist
        mkdir: lib/services
      - name: Add lib/services/gemini_chat_service.dart
        path: colorist/lib/services/gemini_chat_service.dart
        replace-contents: |
          // Copyright 2025 The Flutter Authors. All rights reserved.
          // Use of this source code is governed by a BSD-style license that can be
          // found in the LICENSE file.

          import 'dart:async';

          import 'package:colorist_ui/models/message.dart';
          import 'package:colorist_ui/providers/chat_state_notifier.dart';
          import 'package:colorist_ui/providers/log_state_notifier.dart';
          import 'package:firebase_vertexai/firebase_vertexai.dart';
          import 'package:flutter_riverpod/flutter_riverpod.dart';
          import 'package:riverpod_annotation/riverpod_annotation.dart';

          import '../providers/gemini.dart';

          part 'gemini_chat_service.g.dart';

          class GeminiChatService {
            GeminiChatService(this.ref);
            final Ref ref;

            Future<void> sendMessage(String message) async {
              final chatSession = await ref.read(chatSessionProvider.future);
              final chatStateNotifier = ref.read(chatStateNotifierProvider.notifier);
              final logStateNotifier = ref.read(logStateNotifierProvider.notifier);

              chatStateNotifier.addUserMessage(message);
              logStateNotifier.logUserText(message);
              try {
                final responseText =
                    (await chatSession.sendMessage(Content.text(message))).text?.trim() ??
                    'No text response received';
                logStateNotifier.logLlmText(responseText);
                chatStateNotifier.addLlmMessage(responseText, MessageState.complete);
              } catch (e, st) {
                logStateNotifier.logError(e, st: st);
              }
            }
          }

          @riverpod
          GeminiChatService geminiChatService(Ref ref) => GeminiChatService(ref);
      - name: Run build_runner
        path: colorist
        dart: run build_runner build --delete-conflicting-outputs
      - name: Patch lib/main.dart
        path: colorist/lib/main.dart
        patch-u: |
          --- b/colorist/step_02/lib/main.dart
          +++ a/colorist/step_02/lib/main.dart
          @@ -2,15 +2,17 @@
           // Use of this source code is governed by a BSD-style license that can be
           // found in the LICENSE file.
           
          -import 'package:colorist_ui/models/message.dart';
          -import 'package:colorist_ui/providers/chat_state_notifier.dart';
          -import 'package:colorist_ui/providers/log_state_notifier.dart';
          +import 'package:colorist_ui/ui/screens/error_screen.dart';
          +import 'package:colorist_ui/ui/screens/loading_screen.dart';
           import 'package:colorist_ui/ui/screens/main_screen.dart';
           import 'package:flutter/foundation.dart';
           import 'package:flutter/material.dart';
           import 'package:flutter_riverpod/flutter_riverpod.dart';
           import 'package:logging/logging.dart';
           
          +import 'providers/gemini.dart';
          +import 'services/gemini_chat_service.dart';
          +
           void main() async {
             Logger.root.level = Level.ALL;
             Logger.root.onRecord.listen((record) {
          @@ -30,26 +32,22 @@ class MainApp extends ConsumerWidget {
           
             @override
             Widget build(BuildContext context, WidgetRef ref) {
          +    final model = ref.watch(geminiModelProvider);
          +
               return MaterialApp(
                 theme: ThemeData(
                   colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
                 ),
          -      home: MainScreen(
          -        sendMessage: (message) {
          -          sendMessage(message, ref);
          -        },
          +      home: model.when(
          +        data:
          +            (data) => MainScreen(
          +              sendMessage: (text) {
          +                ref.read(geminiChatServiceProvider).sendMessage(text);
          +              },
          +            ),
          +        loading: () => LoadingScreen(message: 'Initializing Gemini Model'),
          +        error: (err, st) => ErrorScreen(error: err),
                 ),
               );
             }
          -
          -  // A fake LLM that just echoes back what it receives.
          -  void sendMessage(String message, WidgetRef ref) {
          -    final chatStateNotifier = ref.read(chatStateNotifierProvider.notifier);
          -    final logStateNotifier = ref.read(logStateNotifierProvider.notifier);
          -
          -    chatStateNotifier.addUserMessage(message);
          -    logStateNotifier.logUserText(message);
          -    chatStateNotifier.addLlmMessage(message, MessageState.complete);
          -    logStateNotifier.logLlmText(message);
          -  }
           }
      - name: Patch macos/Runner/DebugProfile.entitlements
        path: colorist/macos/Runner/DebugProfile.entitlements
        patch-u: |
          --- b/colorist/step_02/macos/Runner/DebugProfile.entitlements
          +++ a/colorist/step_02/macos/Runner/DebugProfile.entitlements
          @@ -8,5 +8,7 @@
           	<true/>
           	<key>com.apple.security.network.server</key>
           	<true/>
          +	<key>com.apple.security.network.client</key>
          +	<true/>
           </dict>
           </plist>
      - name: Patch macos/Runner/Release.entitlements
        path: colorist/macos/Runner/Release.entitlements
        patch-u: |
          --- b/colorist/step_02/macos/Runner/Release.entitlements
          +++ a/colorist/step_02/macos/Runner/Release.entitlements
          @@ -4,5 +4,7 @@
           <dict>
           	<key>com.apple.security.app-sandbox</key>
           	<true/>
          +	<key>com.apple.security.network.client</key>
          +	<true/>
           </dict>
           </plist>
      - name: Patch android/app/build.gradle.kts
        path: colorist/android/app/build.gradle.kts
        patch-u: |
          --- b/firebase-get-to-know-flutter/step_02/android/app/build.gradle
          +++ a/firebase-get-to-know-flutter/step_02/android/app/build.gradle
          @@ -24,7 +24,7 @@ android {
                   applicationId = "com.example.colorist"
                   // You can update the following values to match your application needs.
                   // For more information, see: https://flutter.dev/to/review-gradle-config.
          -        minSdk = flutter.minSdkVersion
          +        minSdk = 23
                   targetSdk = flutter.targetSdkVersion
                   versionCode = flutter.versionCode
                   versionName = flutter.versionName
      - name: Patch macos/Podfile
        path: colorist/macos/Podfile
        patch-u: |
          --- b/colorist/step_02/macos/Podfile
          +++ a/colorist/step_02/macos/Podfile
          @@ -1,4 +1,5 @@
          -platform :osx, '10.14'
          +# Firebase requires at least macOS 10.15
          +platform :osx, '10.15'

           # CocoaPods analytics sends network stats synchronously affecting flutter build latency.
           ENV['COCOAPODS_DISABLE_STATS'] = 'true'
      - name: Patch macos/Runner.xcodeproj/project.pbxproj
        xcode-project-path: colorist/macos/Runner.xcodeproj
        macosx-deployment-target: "10.15"
      - name: Patch ios/Podfile
        path: colorist/ios/Podfile
        patch-u: |
          --- a/firebase-get-to-know-flutter/step_02/ios/Podfile
          +++ b/firebase-get-to-know-flutter/step_02/ios/Podfile
          @@ -1,5 +1,5 @@
          -# Uncomment this line to define a global platform for your project
          -# platform :ios, '12.0'
          +# Firebase requires at least iOS 13.0
          +platform :ios, '13.0'

           # CocoaPods analytics sends network stats synchronously affecting flutter build latency.
           ENV['COCOAPODS_DISABLE_STATS'] = 'true'
      - name: Patch ios/Runner.xcodeproj/project.pbxproj
        xcode-project-path: colorist/ios/Runner.xcodeproj
        iphoneos-deployment-target: "13.0"
      - name: Upgrade deps
        path: colorist
        flutter: pub upgrade --major-versions
      - name: Build iOS simulator bundle
        platforms: [macos]
        path: colorist
        flutter: build ios --simulator
      - name: Build Android app
        path: colorist
        flutter: build apk
      - name: Build macOS app
        platforms: [macos]
        path: colorist
        flutter: build macos
      - name: Build Windows app
        platforms: [windows]
        path: colorist
        flutter: build windows
      - name: Copy step_02
        copydir:
          from: colorist
          to: step_02
      - name: Flutter clean
        path: step_02
        flutter: clean
  - name: Cleanup
    rmdir: colorist
